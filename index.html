<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BNI TimeKeeper — Timer Profissional</title>
    <!-- Versão BNI: Cores oficiais e com Webhook -->
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Bibliotecas para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* Cores oficiais do BNI */
            --bni-red: #C41E3A;
            --bni-red-light: #E53E3E;
            --bni-red-dark: #9B1C2C;
            --bni-gold: #FFD700;
            --bni-gold-light: #FFF59D;
            --bni-gold-dark: #F57F17;
            
            /* Cores complementares */
            --primary-color: var(--bni-red);
            --primary-light: var(--bni-red-light);
            --primary-dark: var(--bni-red-dark);
            --secondary-color: var(--bni-gold);
            --secondary-light: var(--bni-gold-light);
            --secondary-dark: var(--bni-gold-dark);
            
            /* Cores de status */
            --success-color: #10b981;
            --warning-color: var(--bni-gold-dark);
            --danger-color: var(--bni-red);
            
            /* Cores neutras */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Sombras */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Bordas */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bni-red) 0%, var(--bni-gold-dark) 100%);
            color: var(--gray-800);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 100vh;
        }

        /* Header melhorado com cores BNI */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .header:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgb(196 30 58 / 0.25);
        }

        .header-title {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header-title h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--bni-red), var(--bni-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header-title .subtitle {
            color: var(--gray-600);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .meeting-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-field label {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-field label i {
            color: var(--bni-red);
        }

        .info-field input {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            color: var(--gray-800);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .info-field input:focus {
            outline: none;
            border-color: var(--bni-red);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
            background: white;
        }

        .info-field input::placeholder {
            color: var(--gray-400);
        }

        .general-timer {
            text-align: center;
            background: linear-gradient(135deg, var(--bni-red), var(--bni-red-light));
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            color: white;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--bni-gold);
        }

        .general-timer h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .general-time {
            font-size: 2.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: var(--bni-gold);
        }

        /* Layout principal */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            flex: 1;
        }

        .left-panel, .right-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }

        .left-panel:hover, .right-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgb(196 30 58 / 0.15);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--bni-red);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .panel-title i {
            color: var(--bni-gold);
        }

        /* Timer principal melhorado */
        .timer-container {
            background: linear-gradient(135deg, var(--gray-50), white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 1.5rem 0;
            border: 2px solid var(--bni-gold-light);
            text-align: center;
            transition: all 0.3s ease;
        }

        .timer-container:hover {
            border-color: var(--bni-gold);
            box-shadow: var(--shadow-lg);
        }

        .phase-display {
            font-size: 1.125rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .time-display {
            font-size: 4rem;
            font-weight: 800;
            color: var(--bni-red);
            margin: 1rem 0;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 2px 4px rgba(196, 30, 58, 0.1);
        }

        .progress-container {
            margin: 1.5rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--bni-gold-light);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--success-color), #34d399);
            transition: all 0.3s ease;
            border-radius: 6px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--bni-gold-dark), var(--bni-gold));
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--bni-red), var(--bni-red-light));
        }

        /* Botões com cores BNI */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--bni-red), var(--bni-red-light));
            color: white;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--bni-red-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600), var(--gray-500));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--bni-red), var(--bni-red-light));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--bni-gold-dark), var(--bni-gold));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: var(--shadow-md);
        }

        /* Controles */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        /* Legenda melhorada */
        .legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--bni-gold-light);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        .legend-dot.success { background: var(--success-color); }
        .legend-dot.warning { background: var(--bni-gold-dark); }
        .legend-dot.danger { background: var(--bni-red); }

        /* Agenda melhorada */
        .agenda-container {
            margin: 1.5rem 0;
        }

        .agenda-item {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            margin: 0.75rem 0;
            padding: 1rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .agenda-item:hover {
            border-color: var(--bni-gold);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .agenda-item.current {
            background: linear-gradient(135deg, rgba(196, 30, 58, 0.1), rgba(255, 215, 0, 0.1));
            border-color: var(--bni-red);
            box-shadow: var(--shadow-lg);
        }

        .agenda-item.current::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, var(--bni-red), var(--bni-gold));
            border-radius: 0 4px 4px 0;
        }

        .item-badge {
            background: linear-gradient(135deg, var(--bni-red), var(--bni-red-light));
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 2.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--bni-gold);
        }

        .agenda-item input[type="text"] {
            flex: 1;
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-800);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .agenda-item input[type="text"]:focus {
            outline: none;
            border-color: var(--bni-red);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .agenda-item input[type="number"] {
            width: 80px;
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-800);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .agenda-item input[type="number"]:focus {
            outline: none;
            border-color: var(--bni-red);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .agenda-item .btn {
            padding: 0.5rem;
            min-width: auto;
        }

        /* Tabela melhorada */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--bni-gold-light);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: linear-gradient(135deg, var(--bni-red), var(--bni-red-dark));
            color: white;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
        }

        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .table tbody tr:hover {
            background: rgba(196, 30, 58, 0.05);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Overlay melhorado */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20vh;
            font-weight: 800;
            color: white;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .overlay.show { 
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay.success { background: rgba(16, 185, 129, 0.95); }
        .overlay.warning { background: rgba(245, 158, 11, 0.95); }
        .overlay.danger { background: rgba(196, 30, 58, 0.95); }

        /* Dicas e ajuda */
        .help-text {
            text-align: center;
            font-size: 0.875rem;
            color: var(--gray-500);
            margin: 1rem 0;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--bni-gold-light);
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .meeting-info {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header, .left-panel, .right-panel {
                padding: 1.5rem;
            }
            
            .header-title h1 {
                font-size: 2rem;
            }
            
            .time-display {
                font-size: 3rem;
            }
            
            .general-time {
                font-size: 2rem;
            }
            
            .meeting-info {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .legend {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Animações de entrada */
        .fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estados de loading */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header fade-in">
            <div class="header-title">
                <h1>BNI TimeKeeper</h1>
                <p class="subtitle">Sistema Profissional de Controle de Tempo para Reuniões</p>
            </div>
            
            <div class="meeting-info">
                <div class="info-field">
                    <label>
                        <i data-lucide="users"></i>
                        Equipe BNI:
                    </label>
                    <input type="text" id="teamName" placeholder="Nome da equipe BNI">
                </div>
                <div class="info-field">
                    <label>
                        <i data-lucide="calendar"></i>
                        Data da Reunião:
                    </label>
                    <input type="date" id="meetingDate">
                </div>
                <div class="info-field">
                    <label>
                        <i data-lucide="hash"></i>
                        Número da Reunião:
                    </label>
                    <input type="number" id="meetingNumber" placeholder="Ex: 123">
                </div>
                <div class="info-field">
                    <label>
                        <i data-lucide="user-check"></i>
                        TimeKeeper:
                    </label>
                    <input type="text" id="timekeeper" placeholder="Nome do TimeKeeper">
                </div>
            </div>
            
            <div class="general-timer">
                <h3>
                    <i data-lucide="clock"></i>
                    Tempo Total da Reunião
                </h3>
                <div class="general-time" id="generalTime">00:00:00</div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel fade-in">
                <h2 class="panel-title">
                    <i data-lucide="settings"></i>
                    Console de Controle
                </h2>
            
                <div class="controls">
                    <button class="btn btn-secondary" onclick="toggleBeep()">
                        <i data-lucide="volume-2"></i>
                        Campainha: <span id="beepState">Ligada</span>
                    </button>
                    <button class="btn btn-secondary" onclick="saveAgenda()">
                        <i data-lucide="save"></i>
                        Salvar pauta
                    </button>
                    <button class="btn btn-secondary" onclick="loadAgenda()">
                        <i data-lucide="folder-open"></i>
                        Carregar pauta
                    </button>
                    <button id="gravarBtn" class="btn btn-primary" onclick="gravarRelatorios()" disabled>
                        <i data-lucide="cloud-upload"></i>
                        Gravar no Drive
                    </button>
                </div>

                <div class="timer-container">
                    <div class="phase-display" id="phase">Selecione um item e aperte Espaço para iniciar</div>
                    <div class="time-display" id="time">00:00</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar"></div>
                        </div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-dot success"></div>
                            <span>No Tempo</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot warning"></div>
                            <span>Atenção</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot danger"></div>
                            <span>Tempo Esgotado</span>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button id="startPause" class="btn btn-success" onclick="startPause()">
                            <i data-lucide="play"></i>
                            Iniciar
                        </button>
                        <button class="btn btn-primary" onclick="next()">
                            <i data-lucide="skip-forward"></i>
                            Próximo
                        </button>
                        <button class="btn btn-secondary" onclick="reset()">
                            <i data-lucide="rotate-ccw"></i>
                            Zerar
                        </button>
                        <button class="btn btn-danger" onclick="finalizarReuniao()">
                            <i data-lucide="square"></i>
                            Finalizar Reunião
                        </button>
                    </div>
                </div>

                <div class="agenda-container" id="agenda"></div>

                <div class="help-text">
                    <strong>Atalhos:</strong> Espaço (iniciar/pausar) • N (próximo) • R (zerar) • F (tela cheia)<br>
                    <strong>Dica:</strong> Clique no nome para editar • Duração em minutos por item • Use "Salvar pauta" para gravar no navegador
                </div>
            </div>

            <div class="right-panel fade-in">
                <h2 class="panel-title">
                    <i data-lucide="file-text"></i>
                    Relatório da Reunião
                </h2>
                <p style="text-align: center; font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1.5rem;">
                    Planejado × Realizado por item
                </p>
                
                <div class="table-container">
                    <table class="table" id="logTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Etapa</th>
                                <th>Planejado</th>
                                <th>Início</th>
                                <th>Fim</th>
                                <th>Realizado(mm:ss)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hidePlate()"></div>

    <script>
        // Inicializar ícones Lucide
        lucide.createIcons();
        
        // Variáveis globais
        var agendaEl = document.getElementById('agenda');
        var timeEl = document.getElementById('time');
        var phaseEl = document.getElementById('phase');
        var barEl = document.getElementById('bar');
        var logTbody = document.querySelector('#logTable tbody');
        var overlay = document.getElementById('overlay');
        var beepState = document.getElementById('beepState');
        var generalTimeEl = document.getElementById('generalTime');

        // General meeting timer variables
        var meetingStartTime = null;
        var generalElapsed = 0;
        var meetingFinalized = false;

        // Webhook configuration
        var WEBHOOK_URL = 'https://n8n.fortress.tec.br/webhook/Arquivo_TimeKeeper'; // Reativando o webhook

        var DEFAULT_ITEMS = [
            { name: "Boas-vindas, avisos legais, check-in nas redes e apresentação de diretoria/liderança", minutes: 1 },
            { name: "Propósito e visão geral, números, benefícios e valores do BNI", minutes: 2 },
            { name: "Momento de Educação", minutes: 4 },
            { name: "Networkers Notáveis", minutes: 1 },
            { name: "Apresentação de Novos Membros/Renovantes + Código de Ética", minutes: 1 },
            { name: "Apresentações Semanais dos Membros (com Cliente-Sonho)", minutes: 45 },
            { name: "Reforço Cliente-Sonho e Pedidos de Referência", minutes: 2 },
            { name: "Votação Melhor Apresentação da Semana", minutes: 1 },
            { name: "Apresentação dos Convidados", minutes: 5 },
            { name: "Relatório do Vice-Presidente", minutes: 2 },
            { name: "Relatório Comitê de Afiliação", minutes: 1 },
            { name: "Secretário/Tesoureiro: Renovantes 30/60/90 e valores de equipe BNI", minutes: 1 },
            { name: "Secretário/Tesoureiro: Palestrantes próximas 6 semanas", minutes: 1 },
            { name: "Apresentação Principal 1", minutes: 12 },
            { name: "Apresentação Principal 2", minutes: 0 },
            { name: "Momento de Contribuições dos Membros", minutes: 5 },
            { name: "Verificação da Qualidade das Referências", minutes: 1 },
            { name: "Anúncios, Lembretes e Relatórios Especiais", minutes: 2 },
            { name: "Orientação, Agradecimento e encaminhamento de Convidados", minutes: 1 },
            { name: "Sorteio do Prêmio do Palestrante", minutes: 1 },
            { name: "Mensagem final e fechamento", minutes: 1 }
        ];

        var items = [];
        var currentIndex = 0;
        var running = false;
        var lastTick = null;
        var useBeep = true;

        // Inicializar itens
        for (var i = 0; i < DEFAULT_ITEMS.length; i++) {
            items.push({
                name: DEFAULT_ITEMS[i].name,
                minutes: DEFAULT_ITEMS[i].minutes,
                start: null,
                end: null,
                elapsed: 0
            });
        }

        // Funções de formatação
        function fmt(s) {
            s = Math.max(0, Math.floor(s));
            var m = Math.floor(s / 60);
            var sec = s % 60;
            return (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        function fmtHMS(s) {
            s = Math.max(0, Math.floor(s));
            var h = Math.floor(s / 3600);
            var m = Math.floor((s % 3600) / 60);
            var sec = s % 60;
            return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        function updateGeneralTimer() {
            if (meetingStartTime) {
                generalElapsed = Math.floor((Date.now() - meetingStartTime) / 1000);
                generalTimeEl.textContent = fmtHMS(generalElapsed);
            }
        }

        function playBeep(type) {
            if (!useBeep) return;
            try {
                var ctx = new (window.AudioContext || window.webkitAudioContext)();
                var o = ctx.createOscillator();
                var g = ctx.createGain();
                o.connect(g);
                g.connect(ctx.destination);
                o.type = 'sine';
                o.frequency.value = (type === 'warn') ? 1000 : (type === 'near') ? 1400 : 800;
                var dur = (type === 'end') ? 0.45 : 0.18;
                g.gain.setValueAtTime(0.0001, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.03);
                g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
                o.start();
                o.stop(ctx.currentTime + dur + 0.02);
            } catch(e) {}
        }

        function renderAgenda() {
            agendaEl.innerHTML = "";
            for (var idx = 0; idx < items.length; idx++) {
                var it = items[idx];
                var div = document.createElement('div');
                div.className = 'agenda-item';
                if (idx === currentIndex) div.className += ' current';

                var badge = document.createElement('span');
                badge.className = 'item-badge';
                badge.textContent = idx + 1;

                var nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = it.name;
                nameInput.onchange = (function(index) {
                    return function() {
                        items[index].name = this.value;
                        renderLog();
                    };
                })(idx);

                var minutesInput = document.createElement('input');
                minutesInput.type = 'number';
                minutesInput.placeholder = 'min';
                minutesInput.min = '0';
                minutesInput.value = it.minutes;
                minutesInput.onchange = (function(index) {
                    return function() {
                        items[index].minutes = this.value;
                        renderLog();
                    };
                })(idx);

                var selBtn = document.createElement('button');
                selBtn.className = 'btn btn-primary';
                selBtn.innerHTML = '<i data-lucide="target"></i>';
                selBtn.onclick = (function(index) {
                    return function() { selectIndex(index); };
                })(idx);

                var upBtn = document.createElement('button');
                upBtn.className = 'btn btn-secondary';
                upBtn.innerHTML = '<i data-lucide="arrow-up"></i>';
                upBtn.onclick = (function(index) {
                    return function() { move(index, -1); };
                })(idx);

                var downBtn = document.createElement('button');
                downBtn.className = 'btn btn-secondary';
                downBtn.innerHTML = '<i data-lucide="arrow-down"></i>';
                downBtn.onclick = (function(index) {
                    return function() { move(index, 1); };
                })(idx);

                var delBtn = document.createElement('button');
                delBtn.className = 'btn btn-danger';
                delBtn.innerHTML = '<i data-lucide="trash-2"></i>';
                delBtn.onclick = (function(index) {
                    return function() { remove(index); };
                })(idx);

                div.appendChild(badge);
                div.appendChild(nameInput);
                div.appendChild(minutesInput);
                div.appendChild(selBtn);
                div.appendChild(upBtn);
                div.appendChild(downBtn);
                div.appendChild(delBtn);

                agendaEl.appendChild(div);
            }
            
            lucide.createIcons();
        }

        function move(i, d) {
            var j = i + d;
            if (j < 0 || j >= items.length) return;
            var t = items[i];
            items[i] = items[j];
            items[j] = t;
            if (currentIndex === i) currentIndex = j;
            else if (currentIndex === j) currentIndex = i;
            renderAgenda();
            renderLog();
        }

        function remove(i) {
            items.splice(i, 1);
            if (currentIndex >= items.length) currentIndex = items.length - 1;
            renderAgenda();
            renderLog();
        }

        function selectIndex(i) {
            if (i === currentIndex) return;
            
            var currentItem = items[currentIndex];
            if (currentItem && running) {
                if (!currentItem.start) currentItem.start = new Date();
                currentItem.elapsed = currentItem.elapsed || 0;
            }
            
            running = false;
            currentIndex = i;
            lastTick = null;
            
            var startBtn = document.getElementById('startPause');
            startBtn.innerHTML = '<i data-lucide="play"></i> Iniciar';
            lucide.createIcons();
            
            phaseEl.textContent = 'Selecionado: ' + items[i].name;
            renderAgenda();
            tick();
        }

        function tick() {
            var it = items[currentIndex];
            if (!it) {
                timeEl.textContent = "00:00";
                barEl.style.width = '0%';
                barEl.className = 'progress-fill';
                return;
            }

            var total = (parseFloat(it.minutes) || 0) * 60;
            if (running && total > 0) {
                var t = Date.now();
                if (lastTick != null) {
                    it.elapsed += (t - lastTick) / 1000.0;
                }
                lastTick = t;
            } else {
                lastTick = Date.now();
            }

            var remaining = Math.max(0, Math.round(total - (it.elapsed || 0)));
            timeEl.textContent = fmt(remaining);
            phaseEl.textContent = items[currentIndex].name;

            var ratio = total > 0 ? (it.elapsed || 0) / total : 0;
            ratio = Math.min(1.2, ratio);
            barEl.style.width = (Math.min(1, ratio) * 100) + '%';
            barEl.className = 'progress-fill';
            if (ratio >= 1) {
                barEl.className += ' danger';
            } else if (ratio >= 0.8) {
                barEl.className += ' warning';
            }

            if (total > 0 && running) {
                var elapsed = it.elapsed || 0;
                var at80 = Math.abs(elapsed - total * 0.8) < 0.04;
                var at100 = Math.abs(elapsed - total) < 0.04;
                if (at80) playBeep('near');
                if (at100) playBeep('end');
            }

            updateGeneralTimer();
            setTimeout(tick, 100);
        }

        function startPause() {
            var it = items[currentIndex];
            if (!it) return;
            if (!it.minutes) {
                var m = prompt('Defina a duração (minutos) para este item:', '1');
                if (m === null) return;
                it.minutes = parseInt(m, 10) || 0;
                renderAgenda();
            }
            if (!it.start) it.start = new Date();
            
            if (!meetingStartTime && !running) {
                meetingStartTime = Date.now();
            }
            
            running = !running;
            var startBtn = document.getElementById('startPause');
            if (running) {
                startBtn.innerHTML = '<i data-lucide="pause"></i> Pausar';
            } else {
                startBtn.innerHTML = '<i data-lucide="play"></i> Retomar';
            }
            lucide.createIcons();
        }

        function next() {
            var it = items[currentIndex];
            if (it) {
                if (!it.start) it.start = new Date();
                it.end = new Date();
                renderLog();
            }
            
            if (currentIndex >= items.length - 1) {
                finalizarReuniao();
                return;
            }
            
            currentIndex++;
            var nextItem = items[currentIndex];
            if (nextItem) {
                nextItem.start = new Date();
                nextItem.elapsed = 0;
                running = true;
                var startBtn = document.getElementById('startPause');
                startBtn.innerHTML = '<i data-lucide="pause"></i> Pausar';
                lucide.createIcons();
            }
            lastTick = null;
            renderAgenda();
        }

        function reset() {
            var it = items[currentIndex];
            if (!it) return;
            it.elapsed = 0;
            it.start = null;
            it.end = null;
            running = false;
            var startBtn = document.getElementById('startPause');
            startBtn.innerHTML = '<i data-lucide="play"></i> Iniciar';
            lucide.createIcons();
        }

        function renderLog() {
            logTbody.innerHTML = "";
            for (var i = 0; i < items.length; i++) {
                var it = items[i];
                var tr = document.createElement('tr');
                var realizedSec = it.end && it.start ? Math.max(0, Math.round((it.end - it.start) / 1000)) : (it.elapsed || 0);

                var cells = [
                    i + 1,
                    it.name,
                    it.minutes ? (it.minutes + 'm') : '-',
                    it.start ? it.start.toLocaleTimeString() : '-',
                    it.end ? it.end.toLocaleTimeString() : '-',
                    realizedSec ? fmt(realizedSec) : '-'
                ];

                cells.forEach(function(content) {
                    var td = document.createElement('td');
                    td.textContent = content;
                    tr.appendChild(td);
                });

                logTbody.appendChild(tr);
            }
        }

        function toggleBeep() {
            useBeep = !useBeep;
            beepState.textContent = useBeep ? 'Ligada' : 'Desligada';
        }

        function saveAgenda() {
            localStorage.setItem('bni-timekeeper-agenda', JSON.stringify(items));
            alert('Pauta salva com sucesso!');
        }

        function loadAgenda() {
            var saved = localStorage.getItem('bni-timekeeper-agenda');
            if (saved) {
                items = JSON.parse(saved);
                currentIndex = 0;
                running = false;
                renderAgenda();
                renderLog();
                alert('Pauta carregada com sucesso!');
            } else {
                alert('Nenhuma pauta salva encontrada.');
            }
        }

        function finalizarReuniao() {
            if (confirm('Tem certeza que deseja finalizar a reunião?')) {
                running = false;
                var startBtn = document.getElementById('startPause');
                startBtn.innerHTML = '<i data-lucide="play"></i> Iniciar';
                lucide.createIcons();
                
                var currentItem = items[currentIndex];
                if (currentItem && !currentItem.end) {
                    currentItem.end = new Date();
                }
                
                var totalTime = '';
                if (meetingStartTime) {
                    totalTime = fmtHMS(Math.floor((Date.now() - meetingStartTime) / 1000));
                    meetingStartTime = null;
                }
                
                meetingFinalized = true;
                var gravarBtn = document.getElementById('gravarBtn');
                gravarBtn.disabled = false;
                gravarBtn.classList.remove('loading');
                
                renderLog();
                
                if (totalTime) {
                    alert('Reunião finalizada!\nTempo total: ' + totalTime + '\n\nAgora você pode gravar os relatórios no Drive.');
                }
                
                phaseEl.textContent = 'Reunião finalizada';
            }
        }

        // Função para gravar relatórios no webhook
        async function gravarRelatorios() {
            if (!meetingFinalized) {
                alert('A reunião precisa ser finalizada antes de gravar os relatórios.');
                return;
            }

            var teamName = document.getElementById('teamName').value;
            var meetingDate = document.getElementById('meetingDate').value;
            var meetingNumber = document.getElementById('meetingNumber').value;
            var timekeeper = document.getElementById('timekeeper').value;

            if (!teamName || !meetingDate || !meetingNumber || !timekeeper) {
                alert('Por favor, preencha todas as informações da reunião antes de gravar:\n- Equipe BNI\n- Data da Reunião\n- Número da Reunião\n- TimeKeeper');
                return;
            }

            var gravarBtn = document.getElementById('gravarBtn');
            gravarBtn.innerHTML = '<i data-lucide="loader-2"></i> Enviando arquivos...';
            gravarBtn.classList.add('loading');
            gravarBtn.disabled = true;
            lucide.createIcons();

            try {
                // Gerar nome do arquivo baseado nas informações da reunião
                var fileName = 'BNI_' + teamName.replace(/[^a-zA-Z0-9]/g, '_') + '_Reuniao_' + meetingNumber + '_' + meetingDate;
                
                // Gerar PDF como blob
                var pdfBlob = await generatePdfBlob(fileName);
                
                // Gerar XLSX como blob
                var xlsxBlob = await generateXlsxBlob(fileName);
                
                // Gerar CSV como blob
                var csvBlob = await generateCsvBlob(fileName);
                
                // Enviar arquivos para o webhook
                await sendFilesToWebhook(pdfBlob, xlsxBlob, csvBlob, fileName);
                
                gravarBtn.innerHTML = '<i data-lucide="check"></i> Enviado com sucesso';
                gravarBtn.className = 'btn btn-success';
                lucide.createIcons();
                
                alert('Relatórios enviados com sucesso!\n\nPDF: ' + fileName + '.pdf\nXLSX: ' + fileName + '.xlsx\nCSV: ' + fileName + '.csv\n\nOs arquivos foram processados e enviados para o sistema.');
                
            } catch (error) {
                console.error('Erro ao enviar arquivos:', error);
                alert('Erro ao enviar arquivos: ' + error.message);
                gravarBtn.innerHTML = '<i data-lucide="cloud-upload"></i> Gravar no Drive';
                gravarBtn.className = 'btn btn-primary';
                gravarBtn.disabled = false;
                gravarBtn.classList.remove('loading');
                lucide.createIcons();
            }
        }

        // Funções de exportação para BLOBs
        async function generatePdfBlob(fileName) {
            return new Promise((resolve) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                var teamName = document.getElementById('teamName').value || 'Não informado';
                var meetingDate = document.getElementById('meetingDate').value || 'Não informado';
                var meetingNumber = document.getElementById('meetingNumber').value || 'Não informado';
                var timekeeper = document.getElementById('timekeeper').value || 'Não informado';
                var totalTime = generalTimeEl.textContent || '00:00:00';
                
                // Cabeçalho com cores BNI
                doc.setFontSize(20);
                doc.setTextColor(196, 30, 58);
                doc.text('BNI TimeKeeper', 105, 25, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('Relatório da Reunião', 105, 35, { align: 'center' });
                
                // Linha decorativa
                doc.setDrawColor(255, 215, 0);
                doc.setLineWidth(1);
                doc.line(20, 40, 190, 40);
                
                // Informações
                doc.setFontSize(11);
                doc.text('Equipe BNI: ' + teamName, 20, 55);
                doc.text('Data: ' + (meetingDate ? new Date(meetingDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não informado'), 20, 65);
                doc.text('Reunião Nº: ' + meetingNumber, 20, 75);
                doc.text('TimeKeeper: ' + timekeeper, 20, 85);
                doc.text('Tempo Total: ' + totalTime, 20, 95);
                
                // Tabela
                var tableData = [];
                for (var i = 0; i < items.length; i++) {
                    var it = items[i];
                    var planned = (parseFloat(it.minutes) || 0);
                    var realizedSec = it.end && it.start ? Math.max(0, Math.round((it.end - it.start) / 1000)) : Math.round(it.elapsed || 0);
                    
                    tableData.push([
                        (i + 1).toString(),
                        it.name.length > 40 ? it.name.substring(0, 37) + '...' : it.name,
                        planned ? planned + 'm' : '-',
                        it.start ? it.start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-',
                        it.end ? it.end.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-',
                        realizedSec ? fmt(realizedSec) : '-'
                    ]);
                }
                
                doc.autoTable({
                    head: [['#', 'Etapa', 'Planejado', 'Início', 'Fim', 'Realizado(mm:ss)']],
                    body: tableData,
                    startY: 110,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [196, 30, 58] }
                });
                
                const pdfBlob = doc.output('blob');
                resolve(pdfBlob);
            });
        }

        async function generateXlsxBlob(fileName) {
            return new Promise((resolve) => {
                var teamName = document.getElementById('teamName').value;
                var meetingDate = document.getElementById('meetingDate').value;
                var meetingNumber = document.getElementById('meetingNumber').value;
                var timekeeper = document.getElementById('timekeeper').value;
                var totalTime = generalTimeEl.textContent || '00:00:00';
                
                var wsData = [
                    ['BNI TimeKeeper - Relatório da Reunião'],
                    [''],
                    ['Equipe BNI:', teamName],
                    ['Data da Reunião:', new Date(meetingDate + 'T00:00:00').toLocaleDateString('pt-BR')],
                    ['Número da Reunião:', meetingNumber],
                    ['TimeKeeper:', timekeeper],
                    ['Tempo Total da Reunião:', totalTime],
                    [''],
                    ['#', 'Etapa', 'Planejado (min)', 'Início', 'Fim', 'Realizado(mm:ss)']
                ];
                
                for (var i = 0; i < items.length; i++) {
                    var it = items[i];
                    var planned = (parseFloat(it.minutes) || 0);
                    var realizedSec = it.end && it.start ? Math.max(0, Math.round((it.end - it.start) / 1000)) : Math.round(it.elapsed || 0);
                    
                    wsData.push([
                        i + 1,
                        it.name,
                        planned,
                        it.start ? it.start.toLocaleTimeString() : '',
                        it.end ? it.end.toLocaleTimeString() : '',
                        fmt(realizedSec)
                    ]);
                }
                
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.aoa_to_sheet(wsData);
                
                ws['!cols'] = [
                    { wch: 5 },   // #
                    { wch: 50 },  // Etapa
                    { wch: 15 },  // Planejado
                    { wch: 12 },  // Início
                    { wch: 12 },  // Fim
                    { wch: 12 }   // Realizado(mm:ss)
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Relatório TimeKeeper');
                
                const xlsxBlob = new Blob([XLSX.write(wb, {bookType: 'xlsx', type: 'array'})], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                resolve(xlsxBlob);
            });
        }

        async function generateCsvBlob(fileName) {
            return new Promise((resolve) => {
                var teamName = document.getElementById('teamName').value || 'Não informado';
                var meetingDate = document.getElementById('meetingDate').value || 'Não informado';
                var meetingNumber = document.getElementById('meetingNumber').value || 'Não informado';
                var timekeeper = document.getElementById('timekeeper').value || 'Não informado';
                var totalTime = generalTimeEl.textContent || '00:00:00';
                
                var lines = [
                    ["BNI TimeKeeper - Relatório da Reunião"],
                    [""],
                    ["Equipe BNI:", teamName],
                    ["Data da Reunião:", meetingDate ? new Date(meetingDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não informado'],
                    ["Número da Reunião:", meetingNumber],
                    ["TimeKeeper:", timekeeper],
                    ["Tempo Total da Reunião:", totalTime],
                    [""],
                    ["#", "Etapa", "Planejado(min)", "Inicio", "Fim", "Realizado(mm:ss)"]
                ];
                
                for (var i = 0; i < items.length; i++) {
                    var it = items[i];
                    var planned = (parseFloat(it.minutes) || 0);
                    var realizedSec = it.end && it.start ? Math.max(0, Math.round((it.end - it.start) / 1000)) : Math.round(it.elapsed || 0);
                    lines.push([i + 1, it.name, planned, it.start ? it.start.toLocaleTimeString() : "", it.end ? it.end.toLocaleTimeString() : "", realizedSec]);
                }
                
                var csv = lines.map(function(r) {
                    return r.map(function(v) {
                        return '"' + String(v).replace(/"/g, '""') + '"';
                    }).join(",");
                }).join("\n");

                var csvBlob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
                resolve(csvBlob);
            });
        }

        async function sendFilesToWebhook(pdfBlob, xlsxBlob, csvBlob, fileName) {
            const formData = new FormData();
            
            formData.append('teamName', document.getElementById('teamName').value);
            formData.append('meetingDate', document.getElementById('meetingDate').value);
            formData.append('meetingNumber', document.getElementById('meetingNumber').value);
            formData.append('timekeeper', document.getElementById('timekeeper').value);
            formData.append('totalTime', generalTimeEl.textContent || '00:00:00');
            
            formData.append('pdfFile', pdfBlob, fileName + '.pdf');
            formData.append('xlsxFile', xlsxBlob, fileName + '.xlsx');
            formData.append('csvFile', csvBlob, fileName + '.csv');
            
            const meetingData = {
                items: items.map(function(item, index) {
                    var realizedSec = item.end && item.start ? Math.max(0, Math.round((item.end - item.start) / 1000)) : Math.round(item.elapsed || 0);
                    return {
                        number: index + 1,
                        name: item.name,
                        plannedMinutes: parseFloat(item.minutes) || 0,
                        startTime: item.start ? item.start.toISOString() : null,
                        endTime: item.end ? item.end.toISOString() : null,
                        realizedSeconds: realizedSec
                    };
                })
            };
            formData.append('meetingData', JSON.stringify(meetingData));
            
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Erro ao enviar arquivos para o webhook: ' + response.status + ' ' + response.statusText);
            }
            
            return response;
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    startPause();
                    break;
                case 'KeyN':
                    e.preventDefault();
                    next();
                    break;
                case 'KeyR':
                    e.preventDefault();
                    reset();
                    break;
                case 'KeyF':
                    e.preventDefault();
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        document.documentElement.requestFullscreen();
                    }
                    break;
            }
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            renderAgenda();
            renderLog();
            tick();
            
            // Definir data atual
            document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
            
            // Animação de entrada
            setTimeout(() => {
                document.querySelectorAll('.fade-in').forEach((el, index) => {
                    setTimeout(() => {
                        el.style.opacity = '1';
                        el.style.transform = 'translateY(0)';
                    }, index * 200);
                });
            }, 100);
        });

        // Função para ocultar overlay
        function hidePlate() {
            overlay.classList.remove('show');
        }
    </script>
</body>
</html>

